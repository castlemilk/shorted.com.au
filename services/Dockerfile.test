# Test runner Dockerfile
FROM golang:1.24.3-alpine AS builder

# Install necessary tools
RUN apk add --no-cache git curl build-base

# Set working directory
WORKDIR /app

# Copy go module files
COPY go.mod go.sum ./

# Download dependencies
RUN go mod download

# Copy source code
COPY . .

# Build test binaries
RUN go test -c ./test/integration/... -o integration-tests

FROM alpine:3.18

# Install runtime dependencies
RUN apk add --no-cache ca-certificates curl postgresql-client

# Create app directory
WORKDIR /app

# Copy test binaries and source
COPY --from=builder /app/integration-tests .
COPY --from=builder /app/test ./test
COPY --from=builder /app/migrations ./migrations

# Create coverage directory
RUN mkdir -p coverage

# Set executable permissions
RUN chmod +x integration-tests

# Default command
CMD ["./integration-tests", "-test.v"]