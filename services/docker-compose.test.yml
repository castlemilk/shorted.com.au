version: '3.8'

services:
  # PostgreSQL database for testing
  postgres-test:
    image: postgres:15-alpine
    container_name: shorted-postgres-test
    environment:
      POSTGRES_USER: test_user
      POSTGRES_PASSWORD: test_password
      POSTGRES_DB: shorts_test
    ports:
      - "5433:5432"
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
      - ./migrations/000001_initial_schema.up.sql:/docker-entrypoint-initdb.d/001-schema.sql
      - ./test/fixtures/test_data.sql:/docker-entrypoint-initdb.d/002-test-data.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test_user -d shorts_test"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - shorted-test

  # Redis for caching (optional for extended testing)
  redis-test:
    image: redis:7-alpine
    container_name: shorted-redis-test
    ports:
      - "6380:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_test_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - shorted-test

  # Shorts service for integration testing
  shorts-test:
    build:
      context: .
      dockerfile: shorts/Dockerfile
    container_name: shorted-shorts-test
    environment:
      APP_PORT: 9091
      APP_INSECURE: "true"
      APP_STORE_POSTGRES_ADDRESS: postgres-test:5432
      APP_STORE_POSTGRES_USERNAME: test_user
      APP_STORE_POSTGRES_PASSWORD: test_password
      APP_STORE_POSTGRES_DATABASE: shorts_test
    ports:
      - "9092:9091"
    depends_on:
      postgres-test:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - shorted-test

  # Test runner service
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.test
    container_name: shorted-test-runner
    environment:
      DATABASE_URL: postgresql://test_user:test_password@postgres-test:5432/shorts_test
      SHORTS_API_URL: http://shorts-test:9091
      GO_TEST_FLAGS: "-v -tags=integration"
    volumes:
      - .:/app
      - /app/vendor
      - test_coverage:/app/coverage
    depends_on:
      postgres-test:
        condition: service_healthy
      shorts-test:
        condition: service_healthy
    networks:
      - shorted-test
    command: >
      sh -c "
        echo 'Waiting for services to be ready...' &&
        sleep 10 &&
        echo 'Running integration tests...' &&
        go test ./test/integration/... $$GO_TEST_FLAGS -coverprofile=/app/coverage/integration.out &&
        echo 'Integration tests completed!'
      "

  # Database migration service for test setup
  migrate-test:
    image: migrate/migrate:v4.16.2
    container_name: shorted-migrate-test
    volumes:
      - ./migrations:/migrations
    depends_on:
      postgres-test:
        condition: service_healthy
    networks:
      - shorted-test
    command: >
      sh -c "
        echo 'Running database migrations...' &&
        migrate -path=/migrations -database=postgresql://test_user:test_password@postgres-test:5432/shorts_test?sslmode=disable up &&
        echo 'Migrations completed!'
      "

volumes:
  postgres_test_data:
    driver: local
  redis_test_data:
    driver: local
  test_coverage:
    driver: local

networks:
  shorted-test:
    driver: bridge
    name: shorted-test-network