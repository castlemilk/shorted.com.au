name: Sync ASIC Short Position Data

on:
  schedule:
    # Run at 10 AM AEST (12 AM UTC) every weekday
    # ASIC publishes data around 9 AM AEST on trading days
    - cron: '0 0 * * 1-5'
  workflow_dispatch:
    inputs:
      days:
        description: 'Number of days to sync'
        required: false
        default: '1'
        type: choice
        options:
          - '1'
          - '7'
          - '30'
          - '90'

jobs:
  sync-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'web/package-lock.json'
      
      - name: Install dependencies
        working-directory: ./web
        run: npm ci --legacy-peer-deps
      
      - name: Sync ASIC data
        working-directory: ./web
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          DAYS="${{ github.event.inputs.days || '1' }}"
          echo "Syncing ASIC data for the last $DAYS days"
          npm run db:sync-asic -- --days $DAYS
      
      - name: Send notification on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ASIC Data Sync Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `The automated ASIC data sync workflow failed.\n\nWorkflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\nPlease investigate and run manual sync if needed.`,
              labels: ['bug', 'data-sync']
            });
            console.log(`Created issue #${issue.data.number}`);

  # Optional: Update market data after ASIC sync
  update-market-data:
    needs: sync-data
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Trigger market data update
        run: |
          echo "Market data update can be triggered here"
          # Add logic to update stock prices if you have a market data provider