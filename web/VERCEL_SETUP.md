# Vercel Setup Guide

This guide walks you through setting up the application on Vercel with Edge-based rate limiting.

## Prerequisites

- Vercel account
- GitHub repository connected to Vercel
- Domain (optional)

## Step 1: Create Vercel KV Database

1. Go to your [Vercel Dashboard](https://vercel.com/dashboard)
2. Navigate to **Storage** → **Create Database**
3. Select **KV (Key-Value Store)**
4. Choose a name (e.g., `shorted-rate-limit`)
5. Select region: **Sydney (syd1)** (same as your app)
6. Click **Create**

The KV credentials (`KV_REST_API_URL` and `KV_REST_API_TOKEN`) will be automatically added to your project's environment variables.

## Step 2: Configure Environment Variables

In your Vercel project settings, add the following environment variables:

### Required Variables

```bash
# NextAuth
NEXTAUTH_URL=https://your-domain.vercel.app
NEXTAUTH_SECRET=<generate-with-openssl-rand-base64-32>

# Google OAuth
AUTH_GOOGLE_ID=<your-google-client-id>
AUTH_GOOGLE_SECRET=<your-google-client-secret>

# Firebase Admin
AUTH_FIREBASE_PROJECT_ID=<your-firebase-project-id>
AUTH_FIREBASE_CLIENT_EMAIL=<your-firebase-client-email>
AUTH_FIREBASE_PRIVATE_KEY=<your-firebase-private-key>

# API Endpoints
NEXT_PUBLIC_SHORTS_SERVICE_ENDPOINT=<your-api-url>
NEXT_PUBLIC_MARKET_DATA_SERVICE_ENDPOINT=<your-market-data-url>
```

### Automatic Variables (from KV)

These are automatically added when you create the KV database:

```bash
KV_REST_API_URL=<auto-generated>
KV_REST_API_TOKEN=<auto-generated>
```

## Step 3: Link KV Database to Project

1. Go to **Storage** tab in your Vercel project
2. Click **Connect Store**
3. Select the KV database you created
4. Click **Connect**

This ensures the KV database is available to all deployments.

## Step 4: Deploy

### From GitHub

1. Push your changes to GitHub
2. Vercel automatically deploys
3. Check deployment logs for any errors

### From CLI

```bash
# Install Vercel CLI
npm i -g vercel

# Deploy
vercel --prod
```

## Step 5: Verify Rate Limiting

### Test Anonymous Rate Limiting

```bash
# Make 25 rapid requests (limit is 20/min)
for i in {1..25}; do
  curl https://your-domain.vercel.app/api/search/stocks?q=CBA
  sleep 0.1
done

# Should see 429 after 20 requests
```

### Test Authenticated Rate Limiting

```bash
# Login and get session cookie, then:
for i in {1..205}; do
  curl -H "Cookie: next-auth.session-token=YOUR_TOKEN" \
    https://your-domain.vercel.app/api/search/stocks?q=CBA
  sleep 0.1
done

# Should see 429 after 200 requests
```

### Check Headers

```bash
curl -I https://your-domain.vercel.app/api/search/stocks?q=CBA

# Should see:
# X-RateLimit-Limit: 20
# X-RateLimit-Remaining: 19
# X-RateLimit-Reset: 2025-01-15T10:30:00.000Z
```

## Step 6: Monitor

### Vercel Dashboard

1. **Analytics** → See edge function performance
2. **Storage** → Monitor KV usage and requests
3. **Logs** → View real-time request logs

### Check Rate Limit Data

```bash
# Install Vercel CLI
npm i -g vercel

# View KV data
vercel kv list
```

## Local Development

### Option 1: Without KV (Development)

The app works without KV configured. Rate limiting will be disabled in development.

```bash
npm run dev
```

### Option 2: With KV (Recommended)

1. Create a development KV database in Vercel
2. Copy credentials to `.env.local`:

```bash
KV_REST_API_URL=your-dev-kv-url
KV_REST_API_TOKEN=your-dev-kv-token
```

3. Run dev server:

```bash
npm run dev
```

## Troubleshooting

### Rate Limiting Not Working

**Check 1: KV Credentials**

```bash
# Verify in Vercel Dashboard → Settings → Environment Variables
# Make sure KV_REST_API_URL and KV_REST_API_TOKEN are set
```

**Check 2: Middleware Configuration**

```bash
# Check middleware.ts logs
vercel logs <deployment-url>
```

**Check 3: KV Database Connection**

```bash
# In Vercel Dashboard → Storage → Your KV
# Check "Connected Projects" - your project should be listed
```

### 429 Errors Too Frequent

Adjust limits in `middleware.ts`:

```typescript
// Increase limits
anonymousLimiter = new Ratelimit({
  redis,
  limiter: Ratelimit.slidingWindow(50, "60 s"), // Was 20
  // ...
});

authenticatedLimiter = new Ratelimit({
  redis,
  limiter: Ratelimit.slidingWindow(500, "60 s"), // Was 200
  // ...
});
```

### KV Usage Too High

**Cost Optimization:**

1. **Increase Window Size**

   ```typescript
   // From: 20 requests per 60s
   // To: 100 requests per 300s (5 minutes)
   Ratelimit.slidingWindow(100, "300 s");
   ```

2. **Use Fixed Window** (cheaper)

   ```typescript
   // Instead of slidingWindow
   Ratelimit.fixedWindow(20, "60 s");
   ```

3. **Reduce Analytics**
   ```typescript
   new Ratelimit({
     redis,
     limiter: Ratelimit.slidingWindow(20, "60 s"),
     analytics: false, // Disable analytics
   });
   ```

## Cost Monitoring

### Vercel KV Pricing

| Plan       | Included Requests | Additional Cost |
| ---------- | ----------------- | --------------- |
| Hobby      | 10k/day           | $0.20/100k      |
| Pro        | 1M/month          | $0.20/100k      |
| Enterprise | Custom            | Custom          |

### Usage Breakdown

**Per Rate Limit Check:**

- 1 read operation (check current count)
- 1 write operation (increment count)
- **Total: 2 operations per API request**

**Example Costs:**

- 100k API requests/month = 200k KV operations
- Pro plan: Included (under 1M)
- Hobby plan: $0.20 × 2 = $0.40

### Monitoring Costs

1. **Vercel Dashboard** → Storage → Your KV → Usage
2. Set up billing alerts
3. Monitor daily usage trends

## Advanced Configuration

### Per-Endpoint Rate Limits

Modify `middleware.ts` to have different limits per endpoint:

```typescript
function getLimitsForPath(pathname: string) {
  if (pathname.includes("/api/search")) {
    return { anon: 50, auth: 500 };
  }
  if (pathname.includes("/api/market-data/historical")) {
    return { anon: 20, auth: 200 };
  }
  return { anon: 10, auth: 100 }; // Default
}
```

### IP Allowlist/Blocklist

Add to `middleware.ts`:

```typescript
const BLOCKED_IPS = ["1.2.3.4", "5.6.7.8"];
const ALLOWED_IPS = ["9.10.11.12"]; // Unlimited access

const ip = request.ip || request.headers.get("x-forwarded-for");

if (BLOCKED_IPS.includes(ip)) {
  return new NextResponse("Forbidden", { status: 403 });
}

if (ALLOWED_IPS.includes(ip)) {
  return NextResponse.next(); // Skip rate limiting
}
```

### Dynamic Configuration with Edge Config

Use Vercel Edge Config for real-time limit updates without redeployment:

```typescript
import { get } from "@vercel/edge-config";

const config = await get("rateLimits");
const anonLimit = config?.anonymous || 20;
const authLimit = config?.authenticated || 200;
```

## Security Best Practices

1. **Always use HTTPS** in production
2. **Rotate KV tokens** regularly
3. **Monitor for abuse patterns** in Vercel logs
4. **Set up alerts** for unusual traffic spikes
5. **Use Vercel Firewall** (Pro plan) for additional protection

## Support

- [Vercel KV Documentation](https://vercel.com/docs/storage/vercel-kv)
- [Upstash Ratelimit Docs](https://github.com/upstash/ratelimit)
- [Next.js Middleware Docs](https://nextjs.org/docs/app/building-your-application/routing/middleware)

## Next Steps

1. [ ] Set up monitoring alerts
2. [ ] Configure custom domain
3. [ ] Enable Vercel Analytics
4. [ ] Add error tracking (Sentry)
5. [ ] Set up CI/CD pipeline
6. [ ] Configure preview deployments
