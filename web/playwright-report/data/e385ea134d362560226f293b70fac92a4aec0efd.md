# Test info

- Name: Visual Regression Prevention >> Search Results Layout >> search results have consistent layout
- Location: /Users/benebsworth/projects/shorted/web/e2e/algolia-search.spec.ts:412:5

# Error details

```
Error: locator.fill: Test timeout of 30000ms exceeded.
Call log:
  - waiting for locator('input[placeholder*="Search"], input[type="search"]').first()

    at /Users/benebsworth/projects/shorted/web/e2e/algolia-search.spec.ts:420:25
```

# Page snapshot

```yaml
- img
- text: Preview Environment • This is a preview deployment with test data
- button "Dismiss banner":
  - img
- img
- text: "Development Mode • API: http://localhost:9091"
- banner:
  - link "Shorted":
    - /url: /
    - img
    - text: Shorted
  - navigation:
    - link "about":
      - /url: /about
    - link "blog":
      - /url: /blog
  - button "Sign in"
  - navigation:
    - button "Toggle theme":
      - img
      - img
      - text: Toggle theme
- img "Shorted Logo"
- heading "Welcome to Shorted" [level=3]
- paragraph: Sign in to access advanced features and insights
- button "Continue with Google":
  - img
  - text: Continue with Google
- text: Or continue with Email
- textbox "Email"
- text: Password
- textbox "Password"
- button "Sign in"
- text: By signing in, you agree to our
- link "Terms of Service":
  - /url: /terms
- text: and
- link "Privacy Policy":
  - /url: /terms
- contentinfo:
  - paragraph:
    - text: Built with ❤️ by
    - link "castlemilk":
      - /url: https://twitter.com/shorted
  - img
  - text: v0.2.2-548-gc860d799-dirty
  - link "roadmap":
    - /url: /roadmap
    - img
    - text: roadmap
  - link "terms":
    - /url: /terms
    - img
    - text: terms
- alert
```

# Test source

```ts
  320 |     // Should show stock code or company info
  321 |     const hasContent =
  322 |       pageContent.includes("AAA") || pageContent.includes("not found");
  323 |
  324 |     expect(hasContent).toBeTruthy();
  325 |
  326 |     // No image load errors should break the page
  327 |     await expect(page.locator("body")).toBeVisible();
  328 |   });
  329 | });
  330 |
  331 | test.describe("Search API Integration", () => {
  332 |   test("backend search API returns logo URLs", async ({ page }) => {
  333 |     // Get the backend URL from environment or use default
  334 |     const backendUrl =
  335 |       process.env.SHORTS_URL || "http://localhost:9091";
  336 |
  337 |     // Test the search API directly
  338 |     const response = await page.request.get(
  339 |       `${backendUrl}/api/stocks/search?q=BHP&limit=1`,
  340 |     );
  341 |
  342 |     if (response.ok()) {
  343 |       const data = await response.json();
  344 |
  345 |       expect(data.stocks).toBeDefined();
  346 |       expect(data.stocks.length).toBeGreaterThan(0);
  347 |
  348 |       const firstStock = data.stocks[0];
  349 |       expect(firstStock.product_code).toBe("BHP");
  350 |
  351 |       // Logo URL should be present
  352 |       if (firstStock.logoUrl) {
  353 |         expect(firstStock.logoUrl).toContain(
  354 |           "storage.googleapis.com/shorted-company-logos",
  355 |         );
  356 |       }
  357 |     }
  358 |   });
  359 |
  360 |   test("search API supports typo tolerance via Algolia", async ({ page }) => {
  361 |     const backendUrl =
  362 |       process.env.SHORTS_URL || "http://localhost:9091";
  363 |
  364 |     // Search with typo
  365 |     const response = await page.request.get(
  366 |       `${backendUrl}/api/stocks/search?q=commwealth&limit=5`,
  367 |     );
  368 |
  369 |     if (response.ok()) {
  370 |       const data = await response.json();
  371 |
  372 |       // Should find Commonwealth Bank despite typo
  373 |       const hasCBA = data.stocks.some(
  374 |         (s: { product_code: string; name: string }) =>
  375 |           s.product_code === "CBA" ||
  376 |           s.name.toLowerCase().includes("commonwealth"),
  377 |       );
  378 |
  379 |       expect(hasCBA).toBeTruthy();
  380 |     }
  381 |   });
  382 |
  383 |   test("search API returns industry and tags", async ({ page }) => {
  384 |     const backendUrl =
  385 |       process.env.SHORTS_URL || "http://localhost:9091";
  386 |
  387 |     const response = await page.request.get(
  388 |       `${backendUrl}/api/stocks/search?q=BHP&limit=1`,
  389 |     );
  390 |
  391 |     if (response.ok()) {
  392 |       const data = await response.json();
  393 |
  394 |       if (data.stocks.length > 0) {
  395 |         const stock = data.stocks[0];
  396 |
  397 |         // Industry should be present
  398 |         expect(stock.industry).toBeDefined();
  399 |
  400 |         // Tags should be an array
  401 |         expect(Array.isArray(stock.tags)).toBeTruthy();
  402 |       }
  403 |     }
  404 |   });
  405 | });
  406 |
  407 | test.describe("Visual Regression Prevention", () => {
  408 |   test.describe("Search Results Layout", () => {
  409 |     // Skip if no auth
  410 |     test.skip(() => skipAuthTests, "Skipping - requires authentication");
  411 |
  412 |     test("search results have consistent layout", async ({ page }) => {
  413 |       await page.goto("/stocks");
  414 |       await page.waitForLoadState("networkidle");
  415 |
  416 |       const searchInput = page.locator(
  417 |         'input[placeholder*="Search"], input[type="search"]',
  418 |       ).first();
  419 |
> 420 |       await searchInput.fill("bank");
      |                         ^ Error: locator.fill: Test timeout of 30000ms exceeded.
  421 |       await page.waitForTimeout(1500);
  422 |
  423 |       // Take screenshot for visual comparison
  424 |       await page.screenshot({
  425 |         path: "test-results/search-results-layout.png",
  426 |         fullPage: false,
  427 |       });
  428 |
  429 |       // Verify search results container exists
  430 |       const resultsContainer = page.locator(
  431 |         '[class*="search"], [class*="results"], [class*="grid"]',
  432 |       );
  433 |       await expect(resultsContainer.first()).toBeVisible();
  434 |     });
  435 |   });
  436 |
  437 |   test("stock detail page has consistent layout", async ({ page }) => {
  438 |     await page.goto("/shorts/BHP");
  439 |     await page.waitForLoadState("networkidle");
  440 |     await page.waitForTimeout(2000);
  441 |
  442 |     // Take screenshot for visual comparison
  443 |     await page.screenshot({
  444 |       path: "test-results/stock-detail-layout.png",
  445 |       fullPage: false,
  446 |     });
  447 |
  448 |     // Verify key elements are present - check for stock code or company name
  449 |     const hasStockInfo =
  450 |       (await page.locator("text=BHP").first().isVisible({ timeout: 5000 }).catch(() => false)) ||
  451 |       (await page.locator("h1, h2").first().isVisible({ timeout: 5000 }).catch(() => false));
  452 |
  453 |     expect(hasStockInfo).toBeTruthy();
  454 |   });
  455 | });
  456 |
  457 |
```