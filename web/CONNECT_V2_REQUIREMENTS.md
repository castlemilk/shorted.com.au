# Connect RPC v2 Requirements

## Package Versions

**CRITICAL**: This project uses Connect RPC v2.x. Always ensure these package versions:

```json
{
  "@bufbuild/protobuf": "^2.10.1",
  "@bufbuild/protoc-gen-es": "^2.10.1",
  "@connectrpc/connect": "^2.1.0",
  "@connectrpc/connect-query": "^2.2.0",
  "@connectrpc/connect-web": "^2.1.0",
  "@connectrpc/protoc-gen-connect-es": "^1.7.0"
}
```

**IMPORTANT**: Connect v2 uses `protoc-gen-es` v2 to generate service descriptors. The `_connect.ts` files are no longer needed - use service descriptors directly from `_pb.ts` files.

## API Changes from v1 to v2

### Client Creation

**v1 (DEPRECATED):**
```typescript
import { createPromiseClient } from "@connectrpc/connect";
const client = createPromiseClient(Service, transport);
```

**v2 (CORRECT):**
```typescript
import { createClient } from "@connectrpc/connect";
const client = createClient(Service, transport);
```

### Response Handling

**v1 (DEPRECATED):**
```typescript
import { toPlainMessage } from "@bufbuild/protobuf";
const response = await client.getData({ ... });
const plain = toPlainMessage(response);
```

**v2 (CORRECT):**
```typescript
// v2.x returns plain objects directly - no toPlainMessage needed
const response = await client.getData({ ... });
// response is already a plain object
```

### Type Imports

**v1 (DEPRECATED):**
```typescript
import { type PlainMessage, toPlainMessage } from "@bufbuild/protobuf";
```

**v2 (CORRECT):**
```typescript
import type { PlainMessage } from "@bufbuild/protobuf";
// toPlainMessage is not needed - responses are already plain
```

### Service Descriptor Imports

**v1 (DEPRECATED):**
```typescript
import { ShortedStocksService } from "~/gen/shorts/v1alpha1/shorts_connect";
```

**v2 (CORRECT):**
```typescript
import { ShortedStocksService } from "~/gen/shorts/v1alpha1/shorts_pb";
// Service descriptors are now generated by protoc-gen-es v2 directly
```

## Migration Checklist

When updating code to use Connect v2:

- [ ] Replace `createPromiseClient` with `createClient`
- [ ] Remove `toPlainMessage` calls (responses are already plain)
- [ ] Update imports to remove `toPlainMessage` from `@bufbuild/protobuf`
- [ ] **Update service imports**: Use service descriptors from `_pb.ts` files instead of `_connect.ts`
  - Change: `import { Service } from "~/gen/.../service_connect"`
  - To: `import { Service } from "~/gen/.../service_pb"`
- [ ] Verify package.json has correct v2.x versions
- [ ] Regenerate proto files with `protoc-gen-es` v2
- [ ] Test all API calls work correctly

## Common Errors

### Error: `createPromiseClient is not a function`
**Cause**: Using v1 API with v2 packages  
**Fix**: Replace with `createClient`

### Error: `toPlainMessage is not exported`
**Cause**: Trying to use v1 API  
**Fix**: Remove `toPlainMessage` - v2 responses are already plain objects

### Error: `MethodIdempotency is not exported`
**Cause**: Version mismatch between `@connectrpc/connect-web` and `@bufbuild/protobuf`  
**Fix**: Ensure both are v2.x versions (see package versions above)

## Verification

To verify correct versions are installed:
```bash
npm ls @connectrpc/connect @connectrpc/connect-web @bufbuild/protobuf
```

All should show v2.x versions. If you see v1.x, run:
```bash
npm install @connectrpc/connect@^2.1.0 @connectrpc/connect-web@^2.1.0 @bufbuild/protobuf@^2.10.1
```

