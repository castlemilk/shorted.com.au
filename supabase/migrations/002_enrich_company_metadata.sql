-- Migration: Enrich Company Metadata Schema
-- Adds comprehensive fields for AI-generated company profiles

-- Add new columns to company_metadata table
ALTER TABLE company_metadata
ADD COLUMN IF NOT EXISTS tags TEXT[],
ADD COLUMN IF NOT EXISTS enhanced_summary TEXT,
ADD COLUMN IF NOT EXISTS company_history TEXT,
ADD COLUMN IF NOT EXISTS key_people JSONB DEFAULT '[]'::jsonb,
ADD COLUMN IF NOT EXISTS financial_reports JSONB DEFAULT '[]'::jsonb,
ADD COLUMN IF NOT EXISTS competitive_advantages TEXT,
ADD COLUMN IF NOT EXISTS risk_factors TEXT,
ADD COLUMN IF NOT EXISTS recent_developments TEXT,
ADD COLUMN IF NOT EXISTS social_media_links JSONB DEFAULT '{}'::jsonb,
ADD COLUMN IF NOT EXISTS logo_gcs_url TEXT,
ADD COLUMN IF NOT EXISTS enrichment_status VARCHAR(50) DEFAULT 'pending',
ADD COLUMN IF NOT EXISTS enrichment_date TIMESTAMP WITH TIME ZONE,
ADD COLUMN IF NOT EXISTS enrichment_error TEXT;

-- Create GIN index for array search on tags
CREATE INDEX IF NOT EXISTS idx_company_metadata_tags ON company_metadata USING GIN (tags);

-- Create index for enrichment status
CREATE INDEX IF NOT EXISTS idx_company_metadata_enrichment_status ON company_metadata(enrichment_status);

-- Create index for logo_gcs_url
CREATE INDEX IF NOT EXISTS idx_company_metadata_logo_gcs_url ON company_metadata(logo_gcs_url);

-- Add comments for documentation
COMMENT ON COLUMN company_metadata.tags IS 'AI-generated specialty tags for the company (e.g., lithium mining, renewable energy)';
COMMENT ON COLUMN company_metadata.enhanced_summary IS 'Comprehensive company overview (500-1000 words) generated by AI';
COMMENT ON COLUMN company_metadata.company_history IS 'Historical timeline and key milestones';
COMMENT ON COLUMN company_metadata.key_people IS 'Structured data with names, roles, bios, LinkedIn links';
COMMENT ON COLUMN company_metadata.financial_reports IS 'Array of links to annual reports, quarterly reports';
COMMENT ON COLUMN company_metadata.competitive_advantages IS 'Unique strengths and market position';
COMMENT ON COLUMN company_metadata.risk_factors IS 'Key business risks';
COMMENT ON COLUMN company_metadata.recent_developments IS 'Latest news and announcements';
COMMENT ON COLUMN company_metadata.social_media_links IS 'Social media URLs (Twitter, LinkedIn, Facebook)';
COMMENT ON COLUMN company_metadata.logo_gcs_url IS 'Google Cloud Storage URL for company logo';
COMMENT ON COLUMN company_metadata.enrichment_status IS 'Status of AI enrichment: pending, in_progress, completed, failed';
COMMENT ON COLUMN company_metadata.enrichment_date IS 'Timestamp of last enrichment attempt';
COMMENT ON COLUMN company_metadata.enrichment_error IS 'Error message if enrichment failed';

-- Create a view for enriched companies
CREATE OR REPLACE VIEW enriched_company_metadata AS
SELECT 
    stock_code,
    company_name,
    industry,
    sector,
    market_cap,
    logo_url,
    logo_gcs_url,
    website,
    description,
    tags,
    enhanced_summary,
    company_history,
    key_people,
    financial_reports,
    competitive_advantages,
    risk_factors,
    recent_developments,
    social_media_links,
    enrichment_status,
    enrichment_date,
    created_at,
    updated_at
FROM company_metadata
WHERE enrichment_status = 'completed';

-- Create a view for companies needing enrichment
CREATE OR REPLACE VIEW companies_needing_enrichment AS
SELECT 
    stock_code,
    company_name,
    industry,
    website,
    enrichment_status,
    enrichment_date,
    enrichment_error
FROM company_metadata
WHERE enrichment_status IN ('pending', 'failed')
   OR enrichment_status IS NULL
ORDER BY company_name;

