# Shorted.com.au Project Rules

You are an expert full-stack developer working on Shorted.com.au, a platform for tracking short selling positions in the Australian stock market.

## Tech Stack

- **Frontend**: Next.js 14 (App Router), TypeScript, TailwindCSS, Radix UI, Visx charts
- **Backend**: Go 1.24 with Connect-RPC (gRPC-Web compatible)
- **Database**: PostgreSQL (Supabase in prod, Docker locally on port 5438)
- **Infrastructure**: Terraform on Google Cloud Platform (Cloud Run)
- **Data Pipeline**: Python scripts for ASIC data ingestion
- **Search**: Algolia
- **Auth**: NextAuth.js v5 with Firebase

## Directory Structure

```
shorted/
├── web/                    # Next.js frontend
│   ├── src/@/              # Shared components (shadcn pattern)
│   ├── src/app/            # Next.js app router pages
│   ├── src/gen/            # Generated protobuf types
│   └── e2e/                # Playwright E2E tests
├── services/               # Go backend services
│   ├── shorts/             # Main API service (port 9091)
│   ├── market-data/        # Stock price API (port 8090)
│   ├── enrichment-processor/ # Company metadata enrichment
│   ├── daily-sync/         # Scheduled data updates (Python)
│   ├── migrations/         # SQL migrations
│   └── pkg/                # Shared Go packages
├── proto/                  # Protobuf API definitions
├── terraform/              # Infrastructure as code
├── analysis/               # Python data analysis scripts
└── test/                   # Integration and performance tests
```

## Essential Commands (Always Use Makefile)

```bash
# Development
make install          # Install all dependencies
make dev              # Start database + backend + frontend
make dev-db           # Start PostgreSQL only
make dev-frontend     # Start frontend only (port 3020)
make dev-backend      # Start shorts service only (port 9091)
make dev-stop         # Stop all services
make clean-ports      # Kill stale processes on dev ports

# Testing
make test             # Run lint + build + unit tests + integration
make test-frontend    # Frontend tests only (Jest)
make test-backend     # Backend tests only (Go)
make test-integration-local  # Integration tests with testcontainers

# Database
make populate-data    # Download and populate ASIC short data
make db-diagnose      # Diagnose query performance
make db-optimize      # Apply performance indexes
```

## Go Backend Conventions

### Code Style

- Use `go.uber.org/mock/gomock` for mocking (NOT golang/mock)
- Use `go.uber.org/zap` for structured logging via `pkg/log`
- Use `github.com/jackc/pgx/v5` for PostgreSQL
- Use `github.com/testcontainers/testcontainers-go` for integration tests
- Use `github.com/stretchr/testify` for assertions

### Store Pattern

All data access goes through Store interfaces:

```go
type Store interface {
    GetStock(string) (*stockv1alpha1.Stock, error)
    GetTopShorts(string, int32, int32) ([]*stockv1alpha1.TimeSeriesData, int, error)
    // ... other methods
}

func NewStore(config Config) Store {
    switch config.StorageBackend {
    case PostgresStore:
        return newPostgresStore(config)
    default:
        return nil
    }
}
```

### Connect-RPC Services

Services implement generated interfaces from protobuf:

```go
type ShortsService struct {
    store shorts.Store
    log   *log.Logger
}

func (s *ShortsService) GetTopShorts(
    ctx context.Context,
    req *connect.Request[shortsv1alpha1.GetTopShortsRequest],
) (*connect.Response[shortsv1alpha1.GetTopShortsResponse], error) {
    // Implementation
}
```

### Testing Pattern

```go
func TestSomething(t *testing.T) {
    ctrl := gomock.NewController(t)
    defer ctrl.Finish()

    mockStore := mocks.NewMockStore(ctrl)
    mockStore.EXPECT().GetStock("BHP").Return(&stock, nil)

    // Test implementation
}
```

## TypeScript/React Conventions

### Path Aliases

- `@/components/*` → `src/@/components/*`
- `@/lib/*` → `src/@/lib/*`
- `@/hooks/*` → `src/@/hooks/*`
- `~/` → `src/`

### Component Patterns

- Prefer React Server Components (RSC) - minimize `'use client'`
- Use TanStack Query for client-side data fetching
- Use Zod for schema validation
- Use descriptive variable names: `isLoading`, `hasError`, `canSubmit`

### File Structure for Components

```typescript
// 1. Imports
// 2. Types/Interfaces
// 3. Constants
// 4. Main component export
// 5. Sub-components
// 6. Helper functions
```

### Example Component

```tsx
"use client";

import { useMemo } from "react";
import { cn } from "@/lib/utils";

interface SparklineProps {
  data: SparklineData[];
  width: number;
  height: number;
  isPositive?: boolean;
}

export function Sparkline({
  data,
  width,
  height,
  isPositive = true,
}: SparklineProps) {
  const color = isPositive ? "#10b981" : "#ef4444";

  // Early return for invalid data
  if (!data || data.length < 2) return null;

  // Component implementation
}
```

## Database

### Local Development

- Host: `localhost:5438`
- Database: `shorts`
- Username: `admin`
- Password: `password`
- URL: `postgresql://admin:password@localhost:5438/shorts`

### Migrations

```bash
cd services
make migrate-create NAME=add_new_table  # Create migration
make migrate-up                          # Apply migrations
make migrate-down                        # Rollback one migration
```

## Protobuf/API Definitions

### Adding New Endpoints

1. Define in `proto/shortedapi/shorts/v1alpha1/shorts.proto`
2. Run `cd proto && buf generate`
3. Implement in `services/shorts/internal/services/`
4. Generated types available in `web/src/gen/`

### Proto Style

```protobuf
service ShortedStocksService {
  rpc GetTopShorts(GetTopShortsRequest) returns (GetTopShortsResponse) {
    option (google.api.http) = {
      post: "/v1/topShorts"
      body: "*"
    };
  }
}
```

## Error Handling

### Go

```go
// Use early returns
if err != nil {
    return nil, fmt.Errorf("failed to get stock: %w", err)
}
```

### TypeScript

```typescript
// Use guard clauses
if (!data) {
  throw new Error("Data is required");
}
```

## Environment Variables

### Required for Development

```bash
# Database
DATABASE_URL=postgresql://admin:password@localhost:5438/shorts

# GCP (for logo storage, enrichment)
GOOGLE_APPLICATION_CREDENTIALS=path/to/service-account.json
GCP_PROJECT_ID=shorted-dev-aba5688f

# Algolia (search)
ALGOLIA_APP_ID=1BWAPWSTDD
ALGOLIA_SEARCH_KEY=0e5adba5fd8aa4b3848255a39c1287ef

# Optional: AI enrichment
OPENAI_API_KEY=sk-...
GEMINI_API_KEY=...
```

## Common Patterns

### Avoid

- Direct `npm run` or `go run` commands (use Makefile)
- Classes in TypeScript (use functional patterns)
- `useEffect` for data fetching (use TanStack Query or RSC)
- Inline styles (use Tailwind classes)

### Prefer

- Server Components over Client Components
- Makefile commands for all operations
- Interface-based design in Go
- Early returns and guard clauses
- Descriptive error messages with context
