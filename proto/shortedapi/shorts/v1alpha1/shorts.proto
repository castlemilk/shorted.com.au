syntax = "proto3";

package shorts.v1alpha1;

option go_package = "github.com/castlemilk/shorted.com.au/services/gen/proto/go/shorts/v1alpha1;shortsv1alpha1";

import "google/api/annotations.proto";
import "gnostic/openapi/v3/annotations.proto";
import "google/api/client.proto";
import "stocks/v1alpha1/stocks.proto";
import "options/v1/options.proto";

option (gnostic.openapi.v3.document) = {
  info: {
    title: "Shorted API"
    version: "v1"
    description: "Shorted API's"
    contact: {
      url: "shorted.com.au"
      email: "help@shorted.com.au"
    }
    license: {
      name: "Proprietary license"
      url: "https://shorted.com.au/terms"
    }
  }
  servers: [{
    url: "https://api.shorted.com.au"
  }]
  components: {
    security_schemes: {
      additional_properties: [
        {
          name: "AuthToken"
          value: {
            security_scheme: {
              type: "http"
              scheme: "bearer"
            }
          }
        }
      ]
    }
  }
};
service ShortedStocksService {
  option (google.api.default_host) = "api.shorted.com.au";
  
  // Shows top 10 short positions on the ASX over different periods of time.
  rpc GetTopShorts (GetTopShortsRequest) returns (GetTopShortsResponse) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PUBLIC;
    option (google.api.method_signature) = "period,limit,offset";
    option (gnostic.openapi.v3.operation) = {
      deprecated: false,
      summary: "Get Top Shorts",
      description: "Retrieve the top shorted stocks on the ASX for a given time period. Supports pagination and custom limits.",
      responses: {
        response_or_reference: {
          name: "200"
          value: {
            response: {
              description: "A successful response containing time series data for the top shorted stocks."
            }
          }
        },
        response_or_reference: {
          name: "400"
          value: {
            response: {
              description: "Invalid request parameters provided."
            }
          }
        }
      }
    };
  }

  // Get Industry TreeMap for short positions.
  rpc GetIndustryTreeMap(GetIndustryTreeMapRequest) returns (stocks.v1alpha1.IndustryTreeMap) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PUBLIC;
    option (gnostic.openapi.v3.operation) = {
      deprecated: false,
      summary: "Get Industry TreeMap",
      description: "Retrieve a hierarchical treemap of short positions grouped by industry. Useful for visualizing market-wide shorting trends.",
      responses: {
        response_or_reference: {
          name: "200"
          value: {
            response: {
              description: "A successful response containing industry-grouped short position data."
            }
          }
        },
        response_or_reference: {
          name: "400"
          value: {
            response: {
              description: "Invalid request parameters."
            }
          }
        }
      }
    };
  }

  // Provides an overview of a specific stock based on PRODUCT_CODE.
  rpc GetStock (GetStockRequest) returns (stocks.v1alpha1.Stock) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PUBLIC;
    option (gnostic.openapi.v3.operation) = {
      deprecated: false,
      summary: "Get Stock Summary",
      description: "Retrieve a summary of current short positions and basic metadata for a specific stock by its ASX code.",
      responses: {
        response_or_reference: {
          name: "200"
          value: {
            response: {
              description: "A successful response containing the stock summary."
            }
          }
        },
        response_or_reference: {
          name: "404"
          value: {
            response: {
              description: "The specified stock code was not found."
            }
          }
        }
      }
    };
  }

  // Provides a more in-depth breakdown of a particular stock's metadata.
  rpc GetStockDetails (GetStockDetailsRequest) returns (stocks.v1alpha1.StockDetails) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PUBLIC;
    option (gnostic.openapi.v3.operation) = {
      deprecated: false,
      summary: "Get Stock Details",
      description: "Retrieve comprehensive metadata for a specific stock, including company history, key people, and financial reports.",
      responses: {
        response_or_reference: {
          name: "200"
          value: {
            response: {
              description: "A successful response containing detailed stock information."
            }
          }
        },
        response_or_reference: {
          name: "404"
          value: {
            response: {
              description: "The specified stock details were not found."
            }
          }
        }
      }
    };
  }

  // fetch time series data for a specific stock
  rpc GetStockData (GetStockDataRequest) returns (stocks.v1alpha1.TimeSeriesData) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PUBLIC;
    option (gnostic.openapi.v3.operation) = {
      deprecated: false,
      summary: "Get Stock Time Series Data",
      description: "Retrieve historical short position data for a specific stock over a defined time period.",
      responses: {
        response_or_reference: {
          name: "200"
          value: {
            response: {
              description: "A successful response containing historical time series points."
            }
          }
        },
        response_or_reference: {
          name: "401"
          value: {
            response: {
              description: "Authentication is required to access private time series data."
            }
          }
        }
      }
    };
  }
  
  // Search stocks by symbol or company name
  rpc SearchStocks (SearchStocksRequest) returns (SearchStocksResponse) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PUBLIC;
    option (gnostic.openapi.v3.operation) = {
      deprecated: false,
      summary: "Search Stocks",
      description: "Search for ASX stocks using full-text search against their ticker symbol or company name.",
      responses: {
        response_or_reference: {
          name: "200"
          value: {
            response: {
              description: "A list of matching stocks."
            }
          }
        }
      }
    };
  }

  // Get sync status for admin dashboard
  rpc GetSyncStatus (GetSyncStatusRequest) returns (GetSyncStatusResponse) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PRIVATE;
    option (shortedapi.options.v1.required_role) = "admin";
    option (gnostic.openapi.v3.operation) = {
      deprecated: false,
      summary: "Get Sync Status",
      description: "Administrative endpoint to retrieve the status and history of data synchronization tasks. Requires admin role.",
      responses: {
        response_or_reference: {
          name: "200"
          value: {
            response: {
              description: "Recent sync run history."
            }
          }
        },
        response_or_reference: {
          name: "403"
          value: {
            response: {
              description: "Forbidden: Admin role is required."
            }
          }
        }
      }
    };
  }

  // Mint an API token for the user. Requires valid authentication.
  rpc MintToken (MintTokenRequest) returns (MintTokenResponse) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PRIVATE;
    option (gnostic.openapi.v3.operation) = {
      deprecated: false,
      summary: "Mint API Token",
      description: "Generate a bespoke API token for programmatic access to Shorted APIs. Requires valid session authentication.",
      responses: {
        response_or_reference: {
          name: "200"
          value: {
            response: {
              description: "A new API token."
            }
          }
        },
        response_or_reference: {
          name: "401"
          value: {
            response: {
              description: "Unauthorized: User must be signed in."
            }
          }
        }
      }
    };
  }
}

message MintTokenRequest {
}

message MintTokenResponse {
  string token = 1;
}

// Request for Top10 RPC, specifying the period of time.
message GetTopShortsRequest {
  string period = 1;
  int32 limit = 2;
  int32 offset = 3;
}

// Request for Top10 RPC, specifying the period of time.
message GetIndustryTreeMapRequest {
  // time over which to look at the max value
  string period = 1;
  // number of stocks to return for each parent
  int32 limit = 2;
  
  ViewMode view_mode = 3;
}

enum ViewMode {
   // return the current/latest short positions
   CURRENT_CHANGE = 0;
   // return the percentage change in short positions
   PERCENTAGE_CHANGE = 1;
}

// Response for Top10 RPC, including time series data for each of the top 10 short positions.
message GetTopShortsResponse {
  repeated stocks.v1alpha1.TimeSeriesData time_series = 1;
  int32 offset = 2;
}

// Request for GetStockSummary RPC, specifying the product code.
message GetStockRequest {
  string product_code = 1;
}

// Request for GetStockDetails RPC, specifying the product code.
message GetStockDetailsRequest {
  string product_code = 1;
}

// Request for GetStockDataRequest RPC, specifying the product code.
message GetStockDataRequest {
  string product_code = 1;
  string period = 2;
}

// Request for SearchStocks RPC, specifying the search query.
message SearchStocksRequest {
  string query = 1;           // Search query (symbol or company name)
  int32 limit = 2;           // Maximum number of results to return (default: 50)
  bool include_details = 3;  // Whether to include detailed stock information
}

// Response for SearchStocks RPC, containing matching stocks.
message SearchStocksResponse {
  string query = 1;                    // The search query used
  repeated stocks.v1alpha1.Stock stocks = 2;  // Matching stocks
  int32 count = 3;                     // Number of results returned
}

// Request for GetSyncStatus RPC
message GetSyncStatusRequest {
  int32 limit = 1; // Number of past runs to return (default: 10)
}

// Response for GetSyncStatus RPC
message GetSyncStatusResponse {
  repeated SyncRun runs = 1;
}

// Represents a single sync run execution
message SyncRun {
  string run_id = 1;
  string started_at = 2;
  string completed_at = 3;
  string status = 4;
  string error_message = 5;
  int32 shorts_records_updated = 6;
  int32 prices_records_updated = 7;
  int32 metrics_records_updated = 8;
  int32 algolia_records_synced = 9;
  double total_duration_seconds = 10;
  string environment = 11;
  string hostname = 12;
}
