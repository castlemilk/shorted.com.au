syntax = "proto3";

package shorts.v1alpha1;

option go_package = "github.com/castlemilk/shorted.com.au/services/gen/proto/go/shorts/v1alpha1;shortsv1alpha1";

import "google/api/annotations.proto";
import "gnostic/openapi/v3/annotations.proto";
import "google/api/client.proto";
import "google/protobuf/timestamp.proto";
import "stocks/v1alpha1/stocks.proto";
import "options/v1/options.proto";

option (gnostic.openapi.v3.document) = {
  info: {
    title: "Shorted API"
    version: "v1"
    description: "Shorted API's"
    contact: {
      url: "shorted.com.au"
      email: "help@shorted.com.au"
    }
    license: {
      name: "Proprietary license"
      url: "https://shorted.com.au/terms"
    }
  }
  servers: [{
    url: "https://api.shorted.com.au"
  }]
  components: {
    security_schemes: {
      additional_properties: [
        {
          name: "AuthToken"
          value: {
            security_scheme: {
              type: "http"
              scheme: "bearer"
            }
          }
        }
      ]
    }
  }
};
service ShortedStocksService {
  option (google.api.default_host) = "api.shorted.com.au";
  
  // Shows top 10 short positions on the ASX over different periods of time.
  rpc GetTopShorts (GetTopShortsRequest) returns (GetTopShortsResponse) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PUBLIC;
    option (google.api.method_signature) = "period,limit,offset";
    option (gnostic.openapi.v3.operation) = {
      deprecated: false,
      summary: "Get Top Shorts",
      description: "Retrieve the top shorted stocks on the ASX for a given time period. Supports pagination and custom limits.",
      responses: {
        response_or_reference: {
          name: "200"
          value: {
            response: {
              description: "A successful response containing time series data for the top shorted stocks."
            }
          }
        },
        response_or_reference: {
          name: "400"
          value: {
            response: {
              description: "Invalid request parameters provided."
            }
          }
        }
      }
    };
  }

  // Get Industry TreeMap for short positions.
  rpc GetIndustryTreeMap(GetIndustryTreeMapRequest) returns (stocks.v1alpha1.IndustryTreeMap) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PUBLIC;
    option (gnostic.openapi.v3.operation) = {
      deprecated: false,
      summary: "Get Industry TreeMap",
      description: "Retrieve a hierarchical treemap of short positions grouped by industry. Useful for visualizing market-wide shorting trends.",
      responses: {
        response_or_reference: {
          name: "200"
          value: {
            response: {
              description: "A successful response containing industry-grouped short position data."
            }
          }
        },
        response_or_reference: {
          name: "400"
          value: {
            response: {
              description: "Invalid request parameters."
            }
          }
        }
      }
    };
  }

  // Provides an overview of a specific stock based on PRODUCT_CODE.
  rpc GetStock (GetStockRequest) returns (stocks.v1alpha1.Stock) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PUBLIC;
    option (gnostic.openapi.v3.operation) = {
      deprecated: false,
      summary: "Get Stock Summary",
      description: "Retrieve a summary of current short positions and basic metadata for a specific stock by its ASX code.",
      responses: {
        response_or_reference: {
          name: "200"
          value: {
            response: {
              description: "A successful response containing the stock summary."
            }
          }
        },
        response_or_reference: {
          name: "404"
          value: {
            response: {
              description: "The specified stock code was not found."
            }
          }
        }
      }
    };
  }

  // Provides a more in-depth breakdown of a particular stock's metadata.
  rpc GetStockDetails (GetStockDetailsRequest) returns (stocks.v1alpha1.StockDetails) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PUBLIC;
    option (gnostic.openapi.v3.operation) = {
      deprecated: false,
      summary: "Get Stock Details",
      description: "Retrieve comprehensive metadata for a specific stock, including company history, key people, and financial reports.",
      responses: {
        response_or_reference: {
          name: "200"
          value: {
            response: {
              description: "A successful response containing detailed stock information."
            }
          }
        },
        response_or_reference: {
          name: "404"
          value: {
            response: {
              description: "The specified stock details were not found."
            }
          }
        }
      }
    };
  }

  // fetch time series data for a specific stock
  rpc GetStockData (GetStockDataRequest) returns (stocks.v1alpha1.TimeSeriesData) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PUBLIC;
    option (gnostic.openapi.v3.operation) = {
      deprecated: false,
      summary: "Get Stock Time Series Data",
      description: "Retrieve historical short position data for a specific stock over a defined time period.",
      responses: {
        response_or_reference: {
          name: "200"
          value: {
            response: {
              description: "A successful response containing historical time series points."
            }
          }
        },
        response_or_reference: {
          name: "401"
          value: {
            response: {
              description: "Authentication is required to access private time series data."
            }
          }
        }
      }
    };
  }
  
  // Search stocks by symbol or company name
  rpc SearchStocks (SearchStocksRequest) returns (SearchStocksResponse) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PUBLIC;
    option (gnostic.openapi.v3.operation) = {
      deprecated: false,
      summary: "Search Stocks",
      description: "Search for ASX stocks using full-text search against their ticker symbol or company name.",
      responses: {
        response_or_reference: {
          name: "200"
          value: {
            response: {
              description: "A list of matching stocks."
            }
          }
        }
      }
    };
  }

  // Get sync status for admin dashboard
  rpc GetSyncStatus (GetSyncStatusRequest) returns (GetSyncStatusResponse) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PRIVATE;
    option (shortedapi.options.v1.required_role) = "admin";
    option (gnostic.openapi.v3.operation) = {
      deprecated: false,
      summary: "Get Sync Status",
      description: "Administrative endpoint to retrieve the status and history of data synchronization tasks. Requires admin role.",
      responses: {
        response_or_reference: {
          name: "200"
          value: {
            response: {
              description: "Recent sync run history."
            }
          }
        },
        response_or_reference: {
          name: "403"
          value: {
            response: {
              description: "Forbidden: Admin role is required."
            }
          }
        }
      }
    };
  }

  // Mint an API token for the user. Requires valid authentication.
  rpc MintToken (MintTokenRequest) returns (MintTokenResponse) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PRIVATE;
    option (gnostic.openapi.v3.operation) = {
      deprecated: false,
      summary: "Mint API Token",
      description: "Generate a bespoke API token for programmatic access to Shorted APIs. Requires valid session authentication.",
      responses: {
        response_or_reference: {
          name: "200"
          value: {
            response: {
              description: "A new API token."
            }
          }
        },
        response_or_reference: {
          name: "401"
          value: {
            response: {
              description: "Unauthorized: User must be signed in."
            }
          }
        }
      }
    };
  }

  // Trigger key metrics sync for specific stocks. Admin only.
  rpc SyncKeyMetrics (SyncKeyMetricsRequest) returns (SyncKeyMetricsResponse) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PRIVATE;
    option (shortedapi.options.v1.required_role) = "admin";
    option (gnostic.openapi.v3.operation) = {
      deprecated: false,
      summary: "Sync Key Metrics",
      description: "Trigger on-demand sync of key metrics (market cap, P/E ratio, etc.) for specific stocks. Fetches fresh data from Yahoo Finance. Admin only.",
      responses: {
        response_or_reference: {
          name: "200"
          value: {
            response: {
              description: "Sync completed successfully."
            }
          }
        },
        response_or_reference: {
          name: "403"
          value: {
            response: {
              description: "Forbidden: Admin role required."
            }
          }
        }
      }
    };
  }

  // Trigger enrichment for a specific stock. Admin only.
  // Returns enrichment data for review before applying to company-metadata.
  rpc EnrichStock (EnrichStockRequest) returns (EnrichStockResponse) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PRIVATE;
    option (shortedapi.options.v1.required_role) = "admin";
  }

  // Get top stocks for enrichment batching/prioritization. Admin only.
  rpc GetTopStocksForEnrichment (GetTopStocksForEnrichmentRequest) returns (GetTopStocksForEnrichmentResponse) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PRIVATE;
    option (shortedapi.options.v1.required_role) = "admin";
  }

  // List pending enrichments awaiting review. Admin only.
  rpc ListPendingEnrichments (ListPendingEnrichmentsRequest) returns (ListPendingEnrichmentsResponse) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PRIVATE;
    option (shortedapi.options.v1.required_role) = "admin";
  }

  // Get a specific pending enrichment by ID. Admin only.
  rpc GetPendingEnrichment (GetPendingEnrichmentRequest) returns (GetPendingEnrichmentResponse) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PRIVATE;
    option (shortedapi.options.v1.required_role) = "admin";
  }

  // Approve or reject a pending enrichment. Admin only.
  rpc ReviewEnrichment (ReviewEnrichmentRequest) returns (ReviewEnrichmentResponse) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PRIVATE;
    option (shortedapi.options.v1.required_role) = "admin";
  }

  // Get enrichment job status by job ID. Admin only.
  rpc GetEnrichmentJobStatus (GetEnrichmentJobStatusRequest) returns (GetEnrichmentJobStatusResponse) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PRIVATE;
    option (shortedapi.options.v1.required_role) = "admin";
  }

  // List enrichment jobs with optional status filter. Admin only.
  rpc ListEnrichmentJobs (ListEnrichmentJobsRequest) returns (ListEnrichmentJobsResponse) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PRIVATE;
    option (shortedapi.options.v1.required_role) = "admin";
  }

  // ==================== Subscription Management ====================

  // Internal API for Stripe webhook: handle checkout completion (server-to-server only)
  rpc HandleStripeCheckoutCompleted (HandleStripeCheckoutCompletedRequest) returns (HandleStripeCheckoutCompletedResponse) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PRIVATE;
  }

  // Internal API for Stripe webhook: handle subscription updates (server-to-server only)
  rpc HandleStripeSubscriptionUpdated (HandleStripeSubscriptionUpdatedRequest) returns (HandleStripeSubscriptionUpdatedResponse) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PRIVATE;
  }

  // Get the current user's subscription status. Requires authentication.
  rpc GetMySubscription (GetMySubscriptionRequest) returns (GetMySubscriptionResponse) {
    option (shortedapi.options.v1.visibility) = VISIBILITY_PRIVATE;
  }
}

message MintTokenRequest {
}

message MintTokenResponse {
  string token = 1;
}

// Request for Top10 RPC, specifying the period of time.
message GetTopShortsRequest {
  string period = 1;
  int32 limit = 2;
  int32 offset = 3;
}

// Request for Top10 RPC, specifying the period of time.
message GetIndustryTreeMapRequest {
  // time over which to look at the max value
  string period = 1;
  // number of stocks to return for each parent
  int32 limit = 2;
  
  ViewMode view_mode = 3;
}

enum ViewMode {
   // return the current/latest short positions
   CURRENT_CHANGE = 0;
   // return the percentage change in short positions
   PERCENTAGE_CHANGE = 1;
}

// Response for Top10 RPC, including time series data for each of the top 10 short positions.
message GetTopShortsResponse {
  repeated stocks.v1alpha1.TimeSeriesData time_series = 1;
  int32 offset = 2;
}

// Request for GetStockSummary RPC, specifying the product code.
message GetStockRequest {
  string product_code = 1;
}

// Request for GetStockDetails RPC, specifying the product code.
message GetStockDetailsRequest {
  string product_code = 1;
}

// Request for GetStockDataRequest RPC, specifying the product code.
message GetStockDataRequest {
  string product_code = 1;
  string period = 2;
}

// Request for SearchStocks RPC, specifying the search query.
message SearchStocksRequest {
  string query = 1;           // Search query (symbol or company name)
  int32 limit = 2;           // Maximum number of results to return (default: 50)
  bool include_details = 3;  // Whether to include detailed stock information
}

// Response for SearchStocks RPC, containing matching stocks.
message SearchStocksResponse {
  string query = 1;                    // The search query used
  repeated stocks.v1alpha1.Stock stocks = 2;  // Matching stocks
  int32 count = 3;                     // Number of results returned
}

// Request for GetSyncStatus RPC
message GetSyncStatusRequest {
  int32 limit = 1; // Number of past runs to return (default: 10)
}

// Response for GetSyncStatus RPC
message GetSyncStatusResponse {
  repeated SyncRun runs = 1;
}

// Represents a single sync run execution
message SyncRun {
  string run_id = 1;
  string started_at = 2;
  string completed_at = 3;
  string status = 4;
  string error_message = 5;
  int32 shorts_records_updated = 6;
  int32 prices_records_updated = 7;
  int32 metrics_records_updated = 8;
  int32 algolia_records_synced = 9;
  double total_duration_seconds = 10;
  string environment = 11;
  string hostname = 12;
  
  // Checkpoint tracking
  int32 checkpoint_stocks_total = 13;
  int32 checkpoint_stocks_processed = 14;
  int32 checkpoint_stocks_successful = 15;
  int32 checkpoint_stocks_failed = 16;
}

// Request for SyncKeyMetrics RPC
message SyncKeyMetricsRequest {
  repeated string stock_codes = 1; // Stock codes to sync (e.g., ["CVN", "CBA"]). Empty = sync all.
  bool force = 2; // Force sync even if recently updated (default: false)
}

// Response for SyncKeyMetrics RPC
message SyncKeyMetricsResponse {
  int32 total_requested = 1;
  int32 successfully_synced = 2;
  int32 failed = 3;
  repeated StockSyncResult results = 4;
  double duration_seconds = 5;
}

// Result for a single stock sync
message StockSyncResult {
  string stock_code = 1;
  bool success = 2;
  string error_message = 3;
  KeyMetricsData metrics = 4; // The synced metrics if successful
}

// Key metrics data structure
message KeyMetricsData {
  double market_cap = 1;
  double pe_ratio = 2;
  double eps = 3;
  double dividend_yield = 4;
  double beta = 5;
  double fifty_two_week_high = 6;
  double fifty_two_week_low = 7;
  double avg_volume = 8;
}

// Enrichment request
message EnrichStockRequest {
  string stock_code = 1; // Stock code to enrich (e.g., "CBA")
  bool force = 2; // If true, re-enrich even if already enriched
}

// Enrichment response with job ID (async processing)
message EnrichStockResponse {
  string stock_code = 1;
  string job_id = 2; // Job ID for tracking async enrichment
  string message = 3; // Status message
}

// Enrichment status
enum EnrichmentStatus {
  ENRICHMENT_STATUS_UNSPECIFIED = 0;
  ENRICHMENT_STATUS_PENDING_REVIEW = 1; // Enrichment completed, awaiting review
  ENRICHMENT_STATUS_COMPLETED = 2; // Approved and saved
  ENRICHMENT_STATUS_FAILED = 3; // Enrichment failed
  ENRICHMENT_STATUS_REJECTED = 4; // Rejected during review
}

// Enrichment data structure
message EnrichmentData {
  string enhanced_summary = 1;
  string company_history = 2;
  repeated stocks.v1alpha1.CompanyPerson key_people = 3;
  repeated stocks.v1alpha1.FinancialReport financial_reports = 4;
  string competitive_advantages = 5;
  repeated string risk_factors = 6;
  string recent_developments = 7;
  stocks.v1alpha1.SocialMediaLinks social_media_links = 8;
  repeated string tags = 9;
  // Logo URLs (staged for review, applied on approval)
  string logo_gcs_url = 10;           // Full logo PNG URL (background removed)
  string logo_icon_gcs_url = 11;      // Icon-only logo PNG URL  
  string logo_svg_gcs_url = 12;       // Original SVG logo URL (if discovered as SVG)
  string logo_source_url = 13;        // Original URL where the logo was found
  string logo_format = 14;            // Original format of discovered logo (svg, png, etc)
  // Website discovery (when original metadata lacks website)
  string discovered_website = 15;     // Website URL discovered during enrichment
}

// Quality score for enrichment data
message QualityScore {
  double overall_score = 1; // 0.0 to 1.0
  double completeness_score = 2; // How complete is the data
  double accuracy_score = 3; // Estimated accuracy
  repeated string warnings = 4; // Quality warnings
  repeated string strengths = 5; // Quality strengths
}

// Get top stocks for enrichment request
message GetTopStocksForEnrichmentRequest {
  int32 limit = 1; // Number of stocks to return (default: 100)
  EnrichmentPriority priority = 2; // How to prioritize stocks
}

// Enrichment priority
enum EnrichmentPriority {
  ENRICHMENT_PRIORITY_UNSPECIFIED = 0;
  ENRICHMENT_PRIORITY_MARKET_CAP = 1; // Top by market cap
  ENRICHMENT_PRIORITY_SHORT_POSITION = 2; // Top by short position
  ENRICHMENT_PRIORITY_UNENRICHED = 3; // Stocks that haven't been enriched
  ENRICHMENT_PRIORITY_STALE = 4; // Stocks with old enrichment data
}

// Get top stocks response
message GetTopStocksForEnrichmentResponse {
  repeated StockEnrichmentCandidate stocks = 1;
}

// Stock candidate for enrichment
message StockEnrichmentCandidate {
  string stock_code = 1;
  string company_name = 2;
  string industry = 3;
  double market_cap = 4;
  double short_position_percent = 5;
  string enrichment_status = 6;
  google.protobuf.Timestamp last_enriched = 7;
  int32 priority_score = 8; // Higher = more important to enrich
}

// Review enrichment request
message ReviewEnrichmentRequest {
  string stock_code = 1;
  string enrichment_id = 2; // ID from EnrichStockResponse
  bool approve = 3; // true to approve, false to reject
  string review_notes = 4; // Optional notes about the review
}

// Review enrichment response
message ReviewEnrichmentResponse {
  string stock_code = 1;
  bool approved = 2;
  string message = 3;
}

// List pending enrichments request
message ListPendingEnrichmentsRequest {
  int32 limit = 1;  // Default: 100
  int32 offset = 2; // Default: 0
}

// List pending enrichments response
message ListPendingEnrichmentsResponse {
  repeated PendingEnrichmentSummary enrichments = 1;
}

// A summary view of a pending enrichment (for listing)
message PendingEnrichmentSummary {
  string enrichment_id = 1;
  string stock_code = 2;
  EnrichmentStatus status = 3;
  google.protobuf.Timestamp created_at = 4;
  QualityScore quality_score = 5;
}

// Get a pending enrichment request
message GetPendingEnrichmentRequest {
  string enrichment_id = 1;
}

// Get a pending enrichment response
message GetPendingEnrichmentResponse {
  PendingEnrichment pending = 1;
}

// Full pending enrichment record (for review UI)
message PendingEnrichment {
  string enrichment_id = 1;
  string stock_code = 2;
  EnrichmentStatus status = 3;
  EnrichmentData data = 4;
  QualityScore quality_score = 5;
  google.protobuf.Timestamp created_at = 6;
  google.protobuf.Timestamp reviewed_at = 7;
  string reviewed_by = 8;
  string review_notes = 9;
}

// Enrichment job status enum
enum EnrichmentJobStatus {
  ENRICHMENT_JOB_STATUS_UNSPECIFIED = 0;
  ENRICHMENT_JOB_STATUS_QUEUED = 1; // Job created, waiting to be processed
  ENRICHMENT_JOB_STATUS_PROCESSING = 2; // Currently being processed
  ENRICHMENT_JOB_STATUS_COMPLETED = 3; // Completed successfully
  ENRICHMENT_JOB_STATUS_FAILED = 4; // Failed with error
  ENRICHMENT_JOB_STATUS_CANCELLED = 5; // Cancelled before completion
}

// Enrichment job record
message EnrichmentJob {
  string job_id = 1;
  string stock_code = 2;
  EnrichmentJobStatus status = 3;
  int32 priority = 4;
  bool force = 5;
  google.protobuf.Timestamp created_at = 6;
  google.protobuf.Timestamp started_at = 7;
  google.protobuf.Timestamp completed_at = 8;
  string error_message = 9;
  string enrichment_id = 10; // Set when job completes and enrichment is saved
}

// Get enrichment job status request
message GetEnrichmentJobStatusRequest {
  string job_id = 1;
}

// Get enrichment job status response
message GetEnrichmentJobStatusResponse {
  EnrichmentJob job = 1;
}

// List enrichment jobs request
message ListEnrichmentJobsRequest {
  int32 limit = 1; // Default: 100
  int32 offset = 2; // Default: 0
  EnrichmentJobStatus status = 3; // Optional filter by status
}

// List enrichment jobs response
message ListEnrichmentJobsResponse {
  repeated EnrichmentJob jobs = 1;
  int32 total_count = 2;
}

// ==================== Subscription Messages ====================

// Subscription status enum
enum SubscriptionStatus {
  SUBSCRIPTION_STATUS_UNSPECIFIED = 0;
  SUBSCRIPTION_STATUS_ACTIVE = 1;
  SUBSCRIPTION_STATUS_TRIALING = 2;
  SUBSCRIPTION_STATUS_PAST_DUE = 3;
  SUBSCRIPTION_STATUS_CANCELED = 4;
  SUBSCRIPTION_STATUS_INACTIVE = 5;
}

// Subscription tier enum
enum SubscriptionTier {
  SUBSCRIPTION_TIER_UNSPECIFIED = 0;
  SUBSCRIPTION_TIER_FREE = 1;
  SUBSCRIPTION_TIER_PRO = 2;
  SUBSCRIPTION_TIER_ENTERPRISE = 3;
}

// Request for HandleStripeCheckoutCompleted RPC (called by webhook)
message HandleStripeCheckoutCompletedRequest {
  string user_id = 1;                    // User ID from session metadata
  string user_email = 2;                 // User email from session metadata
  string stripe_customer_id = 3;         // Stripe customer ID
  string stripe_subscription_id = 4;     // Stripe subscription ID
  SubscriptionTier tier = 5;             // Subscription tier (defaults to PRO)
}

// Response for HandleStripeCheckoutCompleted RPC
message HandleStripeCheckoutCompletedResponse {
  bool success = 1;
  string message = 2;
}

// Request for HandleStripeSubscriptionUpdated RPC (called by webhook)
message HandleStripeSubscriptionUpdatedRequest {
  string stripe_customer_id = 1;         // Stripe customer ID (used for lookup)
  string stripe_subscription_id = 2;     // Stripe subscription ID
  SubscriptionStatus status = 3;         // New subscription status
  SubscriptionTier tier = 4;             // Subscription tier
  google.protobuf.Timestamp current_period_start = 5;
  google.protobuf.Timestamp current_period_end = 6;
  bool cancel_at_period_end = 7;
  bool is_deleted = 8;                   // True if subscription was deleted/canceled permanently
}

// Response for HandleStripeSubscriptionUpdated RPC
message HandleStripeSubscriptionUpdatedResponse {
  bool success = 1;
  string message = 2;
}

// Request for GetMySubscription RPC (empty, uses auth context)
message GetMySubscriptionRequest {}

// Response for GetMySubscription RPC
message GetMySubscriptionResponse {
  bool has_subscription = 1;             // Whether user has any subscription record
  SubscriptionStatus status = 2;         // Current subscription status
  SubscriptionTier tier = 3;             // Current subscription tier
  google.protobuf.Timestamp current_period_end = 4;
  bool cancel_at_period_end = 5;
  string stripe_customer_id = 6;         // For portal access
}
