name: Sync Algolia Index

on:
  # Trigger manually from GitHub UI
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to sync'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview

  # Trigger after daily sync completes
  workflow_run:
    workflows: ["Daily Sync"]
    types:
      - completed

  # Schedule: Run every day at 3 AM AEST (after daily sync at 2 AM)
  schedule:
    - cron: '0 16 * * *'  # 16:00 UTC = 03:00 AEST

env:
  NODE_VERSION: "20"

jobs:
  sync-algolia:
    name: Sync Algolia Index
    runs-on: ubuntu-latest
    
    # Only run if:
    # - Manual trigger OR
    # - Scheduled run OR
    # - Daily Sync completed successfully
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        working-directory: web
        run: npm ci --legacy-peer-deps

      - name: Sync Algolia Index
        working-directory: web
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          ALGOLIA_APP_ID: ${{ secrets.ALGOLIA_APP_ID }}
          ALGOLIA_ADMIN_KEY: ${{ secrets.ALGOLIA_ADMIN_KEY }}
          ALGOLIA_INDEX: stocks
        run: |
          echo "üîç Syncing Algolia index..."
          echo "   Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "   Trigger: ${{ github.event_name }}"
          echo ""
          
          npx tsx scripts/sync-algolia.ts

      - name: Report Success
        if: success()
        run: |
          echo "‚úÖ Algolia index synced successfully!"
          echo ""
          echo "Index: stocks"
          echo "App ID: ${{ secrets.ALGOLIA_APP_ID }}"

      - name: Report Failure
        if: failure()
        run: |
          echo "‚ùå Algolia sync failed!"
          echo "Check the logs above for details."
