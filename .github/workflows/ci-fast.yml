name: Fast CI

# Optimized CI pipeline targeting <2 minute execution
# Uses aggressive caching and parallel job execution

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: "20"
  GO_VERSION: "1.23"
  # Shared env vars for all frontend jobs
  NEXT_PUBLIC_SHORTS_SERVICE_ENDPOINT: "https://api.shorted.com.au"
  NEXT_PUBLIC_ALGOLIA_APP_ID: "test"
  NEXT_PUBLIC_ALGOLIA_SEARCH_KEY: "test"
  NEXTAUTH_SECRET: "test-secret-for-ci"
  NEXTAUTH_URL: "http://localhost:3000"
  AUTH_FIREBASE_PROJECT_ID: "test-project"
  AUTH_FIREBASE_CLIENT_EMAIL: "test@test.iam.gserviceaccount.com"
  AUTH_FIREBASE_PRIVATE_KEY: "-----BEGIN PRIVATE KEY-----\ntest\n-----END PRIVATE KEY-----"
  AUTH_GOOGLE_ID: "test.apps.googleusercontent.com"
  AUTH_GOOGLE_SECRET: "test-secret"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # STAGE 0: Dependency installation (cached)
  # ============================================

  setup-frontend:
    name: Setup Frontend
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache node_modules
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: web/node_modules
          key: node-modules-${{ hashFiles('web/package-lock.json') }}
          restore-keys: |
            node-modules-

      - name: Install dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        working-directory: web
        run: npm ci --legacy-peer-deps

  # ============================================
  # STAGE 1: Fast checks (run in parallel)
  # ============================================

  lint-frontend:
    name: Lint Frontend
    runs-on: ubuntu-latest
    needs: setup-frontend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: web/node_modules
          key: node-modules-${{ hashFiles('web/package-lock.json') }}
          fail-on-cache-miss: true

      - name: Run ESLint
        working-directory: web
        run: npm run lint

  lint-backend:
    name: Lint Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: services/go.sum

      - name: Cache golangci-lint
        uses: actions/cache@v4
        with:
          path: ~/.cache/golangci-lint
          key: golangci-lint-${{ runner.os }}
          restore-keys: golangci-lint-

      - name: Run golangci-lint
        working-directory: services
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin latest
          $(go env GOPATH)/bin/golangci-lint run --timeout=3m \
            --skip-dirs=gen,vendor \
            --skip-files=".*\\.pb\\.go$,.*_mock\\.go$,.*_connect\\.go$" \
            --enable=govet \
            --fast \
            ./... || echo "Lint warnings found (non-blocking)"

  typecheck:
    name: TypeScript Check
    runs-on: ubuntu-latest
    needs: setup-frontend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: web/node_modules
          key: node-modules-${{ hashFiles('web/package-lock.json') }}
          fail-on-cache-miss: true

      - name: TypeScript type check
        working-directory: web
        run: npx tsc --noEmit

  # ============================================
  # STAGE 2: Tests (run in parallel)
  # ============================================

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    needs: setup-frontend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: web/node_modules
          key: node-modules-${{ hashFiles('web/package-lock.json') }}
          fail-on-cache-miss: true

      - name: Run Jest tests
        working-directory: web
        run: npm test -- --watchAll=false --testPathIgnorePatterns=integration --maxWorkers=2

  test-backend-unit:
    name: Test Backend (Unit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: services/go.sum

      - name: Run unit tests
        working-directory: services
        env:
          SKIP_INTEGRATION_TESTS: "true"
        run: |
          go test ./... \
            -short \
            -timeout 5m \
            -skip "TestPostgres|TestIntegration|TestSetup" \
            -cover \
            -coverprofile=coverage.out

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage
          path: services/coverage.out
          retention-days: 7

  # ============================================
  # STAGE 3: Build validation
  # ============================================

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: setup-frontend
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules
        uses: actions/cache@v4
        with:
          path: web/node_modules
          key: node-modules-${{ hashFiles('web/package-lock.json') }}
          fail-on-cache-miss: true

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: web/.next/cache
          key: nextjs-cache-${{ hashFiles('web/package-lock.json') }}-${{ hashFiles('web/src/**/*') }}
          restore-keys: |
            nextjs-cache-${{ hashFiles('web/package-lock.json') }}-
            nextjs-cache-

      - name: Build Next.js
        working-directory: web
        run: npm run build

  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: services/go.sum

      - name: Build all services
        working-directory: services
        run: |
          go build -o /dev/null ./shorts/cmd/server
          go build -o /dev/null ./market-data

  # ============================================
  # GATE: All checks must pass
  # ============================================

  ci-pass:
    name: CI Pass Gate
    runs-on: ubuntu-latest
    needs:
      - lint-frontend
      - lint-backend
      - typecheck
      - test-frontend
      - test-backend-unit
      - build-frontend
      - build-backend
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          FAILED=""
          [ "${{ needs.lint-frontend.result }}" != "success" ] && FAILED="$FAILED lint-frontend"
          [ "${{ needs.lint-backend.result }}" != "success" ] && FAILED="$FAILED lint-backend"
          [ "${{ needs.typecheck.result }}" != "success" ] && FAILED="$FAILED typecheck"
          [ "${{ needs.test-frontend.result }}" != "success" ] && FAILED="$FAILED test-frontend"
          [ "${{ needs.test-backend-unit.result }}" != "success" ] && FAILED="$FAILED test-backend-unit"
          [ "${{ needs.build-frontend.result }}" != "success" ] && FAILED="$FAILED build-frontend"
          [ "${{ needs.build-backend.result }}" != "success" ] && FAILED="$FAILED build-backend"

          if [ -n "$FAILED" ]; then
            echo "❌ Failed jobs:$FAILED"
            exit 1
          fi
          echo "✅ All CI checks passed!"

  # ============================================
  # OPTIONAL: Integration tests (main only)
  # ============================================

  test-backend-integration:
    name: Test Backend (Integration)
    runs-on: ubuntu-latest
    needs: [ci-pass]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    services:
      docker:
        image: docker:24-dind
        options: --privileged
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: services/go.sum

      - name: Run integration tests
        working-directory: services
        env:
          DOCKER_HOST: unix:///var/run/docker.sock
          TESTCONTAINERS_RYUK_DISABLED: true
        run: go test ./... -v -timeout 15m -run "TestPostgres|TestIntegration"
