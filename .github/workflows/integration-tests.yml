name: Integration Tests

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      debug:
        description: 'Enable debug logging'
        required: false
        default: 'false'
        type: boolean

env:
  GO_VERSION: '1.23'
  NODE_VERSION: '18'
  POSTGRES_VERSION: '15'

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        test-suite: [api, database, full-stack]

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: shorted_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: services/go.sum

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: web/package-lock.json

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Cache Node modules
        uses: actions/cache@v4
        with:
          path: |
            web/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install Go dependencies
        working-directory: services
        run: |
          go mod download
          go mod verify

      - name: Install Node dependencies
        working-directory: web
        run: |
          npm ci --legacy-peer-deps
          
      - name: Setup test database
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DB: shorted_test
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        run: |
          # Wait for PostgreSQL to be ready
          echo "Waiting for PostgreSQL to be ready..."
          for i in {1..30}; do
            if pg_isready -h localhost -p 5432 -U test_user; then
              echo "PostgreSQL is ready"
              break
            fi
            echo "Waiting for PostgreSQL... attempt $i/30"
            sleep 2
          done
          
          # Initialize database schema
          echo "Setting up database schema..."
          PGPASSWORD=test_password psql -h localhost -p 5432 -U test_user -d shorted_test -f analysis/sql/init-db.sql || true
          
          # Insert test data
          echo "Inserting test data..."
          cd services && go run cmd/test-data-setup/main.go || echo "Test data setup completed with warnings"

      - name: Build backend services
        working-directory: services
        run: |
          echo "Building shorts service..."
          cd shorts/cmd/server && go build -v -o shorts-service .
          
          echo "Building market-data service..."
          cd ../../market-data && go build -v -o market-data-service . || echo "Market data service build completed"

      - name: Run API Integration Tests
        if: matrix.test-suite == 'api' || matrix.test-suite == 'full-stack'
        working-directory: test/integration
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: shorted_test
          DB_USER: test_user
          DB_PASSWORD: test_password
          API_BASE_URL: http://localhost:8081
          DEBUG: ${{ inputs.debug }}
        run: |
          echo "Running API integration tests..."
          go mod download
          go test -v -coverprofile=api-coverage.out -covermode=atomic ./... -tags=integration

      - name: Run Database Integration Tests
        if: matrix.test-suite == 'database' || matrix.test-suite == 'full-stack'
        working-directory: services
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: shorted_test
          DB_USER: test_user
          DB_PASSWORD: test_password
          GO_ENV: test
        run: |
          echo "Running database integration tests..."
          go test -v -coverprofile=db-coverage.out -covermode=atomic ./... -tags=database,integration

      - name: Start test environment for full-stack tests
        if: matrix.test-suite == 'full-stack'
        run: |
          echo "Starting test environment..."
          make test-stack-up
          
          # Wait for services to be ready
          echo "Waiting for services to be ready..."
          timeout 120 bash -c 'until curl -f http://localhost:8081/health > /dev/null 2>&1; do sleep 2; done' || echo "Backend health check timeout"
          timeout 120 bash -c 'until curl -f http://localhost:3001/api/health > /dev/null 2>&1; do sleep 2; done' || echo "Frontend health check timeout"

      - name: Run Full-Stack Integration Tests
        if: matrix.test-suite == 'full-stack'
        working-directory: test/integration
        env:
          FRONTEND_URL: http://localhost:3001
          BACKEND_URL: http://localhost:8081
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: shorted_test
          DB_USER: test_user
          DB_PASSWORD: test_password
        run: |
          echo "Running full-stack integration tests..."
          go test -v -coverprofile=fullstack-coverage.out -covermode=atomic ./... -tags=fullstack,integration

      - name: Combine coverage reports
        run: |
          echo "Combining coverage reports..."
          
          # Create coverage directory
          mkdir -p coverage-reports
          
          # Copy coverage files if they exist
          find . -name "*-coverage.out" -type f -exec cp {} coverage-reports/ \; || true
          
          # Combine Go coverage files
          if ls coverage-reports/*.out 1> /dev/null 2>&1; then
            echo "mode: atomic" > coverage-reports/combined-coverage.out
            tail -n +2 coverage-reports/*-coverage.out >> coverage-reports/combined-coverage.out || true
          fi

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-coverage-${{ matrix.test-suite }}
          path: coverage-reports/
          retention-days: 7

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: coverage-reports/combined-coverage.out
          flags: integration,${{ matrix.test-suite }}
          name: integration-coverage-${{ matrix.test-suite }}
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Generate coverage report
        if: always()
        run: |
          cd services
          if [ -f ../coverage-reports/combined-coverage.out ]; then
            go tool cover -html=../coverage-reports/combined-coverage.out -o ../coverage-reports/integration-coverage.html
            echo "Coverage report generated at coverage-reports/integration-coverage.html"
          fi

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: integration-test-artifacts-${{ matrix.test-suite }}
          path: |
            test/integration/logs/
            services/logs/
            web/logs/
            coverage-reports/
          retention-days: 7

      - name: Show test environment logs on failure
        if: failure() && matrix.test-suite == 'full-stack'
        run: |
          echo "=== Test Environment Logs ==="
          make test-stack-logs || true
          
          echo "=== Docker Container Status ==="
          docker ps -a || true
          
          echo "=== Available Ports ==="
          netstat -tuln || ss -tuln || true

      - name: Cleanup test environment
        if: always() && matrix.test-suite == 'full-stack'
        run: |
          echo "Cleaning up test environment..."
          make test-stack-down || true
          
          # Additional cleanup
          docker system prune -f --filter "label=com.docker.compose.project=integration" || true

  test-summary:
    runs-on: ubuntu-latest
    needs: integration-tests
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: test-results

      - name: Generate test summary
        run: |
          echo "# Integration Test Results ðŸ§ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if any tests failed
          if [ "${{ needs.integration-tests.result }}" != "success" ]; then
            echo "âŒ **Integration tests failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the individual job logs for detailed information." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **All integration tests passed**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Suites" >> $GITHUB_STEP_SUMMARY
          echo "- API Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Database Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Full-Stack Integration Tests" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Coverage Reports" >> $GITHUB_STEP_SUMMARY
          echo "Coverage reports are available in the job artifacts." >> $GITHUB_STEP_SUMMARY

      - name: Upload combined artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: test-results/
          retention-days: 30